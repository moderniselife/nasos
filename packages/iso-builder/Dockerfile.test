FROM debian:bookworm

# Set environment variables for cross-platform build
ENV DEBIAN_FRONTEND=noninteractive

# Install required packages for ISO building
RUN dpkg --add-architecture amd64 && \
    apt-get update && apt-get install -y \
    debootstrap \
    grub-common \
    grub2-common \
    grub-efi-amd64 \
    grub-efi-amd64-bin \
    grub-pc-bin \
    mtools \
    xorriso \
    squashfs-tools \
    genisoimage \
    syslinux-common \
    isolinux \
    tree \
    curl \
    sudo \
    qemu-user-static \
    binfmt-support

# Install Node.js
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs

# Set working directory
WORKDIR /app

# Copy package files
COPY package*.json ./
COPY tsconfig.json ./

# Install dependencies
RUN npm install -g tsx
RUN npm install

# Copy the rest of the application
COPY . .

# Remove the ENTRYPOINT and modify CMD to use shell form
CMD ["bash", "-c", "npm run build:iso"]